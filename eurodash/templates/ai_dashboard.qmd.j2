---
title: "{{ plan.dataset.title or plan.dataset.code }}"
subtitle: "AI-Enhanced Analytics Dashboard"
format:
  html:
    toc: true
    toc-depth: 2
    theme: cosmo
    css: 
      - https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css
    code-fold: true
    page-layout: full
execute:
  echo: false
  warning: false
---

```{python}
import json
from pathlib import Path
import duckdb
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from IPython.display import Markdown, HTML

PLAN_PATH = Path("../../plans") / "{{ plan.dataset.code }}_ai.json"
PLAN = json.loads(PLAN_PATH.read_text(encoding="utf-8"))
DB_PATH = Path("../../warehouse/duckdb/eurodash.duckdb")

con = duckdb.connect(str(DB_PATH))

def run_sql(sql: str) -> pd.DataFrame:
    """Execute SQL query and return DataFrame"""
    try:
        return con.execute(sql).df()
    except Exception as e:
        print(f"SQL Error: {e}")
        return pd.DataFrame()

def format_number(value, fmt="number"):
    """Format numbers for display"""
    if value is None:
        return "N/A"
    if fmt == "decimal":
        return f"{value:,.2f}"
    elif fmt == "percent":
        return f"{value:.1f}%"
    elif fmt == "number":
        return f"{int(value):,}"
    return str(value)

def render_kpi_card(title, value, subtitle=None, icon="fa-chart-line", color="primary"):
    """Render a KPI card"""
    html = f"""
    <div class="card border-{color} mb-3" style="border-left: 4px solid;">
        <div class="card-body">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <h6 class="text-muted mb-1">{title}</h6>
                    <h2 class="mb-0">{value}</h2>
                    {f'<small class="text-muted">{subtitle}</small>' if subtitle else ''}
                </div>
                <div class="text-{color}" style="font-size: 2rem; opacity: 0.3;">
                    <i class="{icon}"></i>
                </div>
            </div>
        </div>
    </div>
    """
    display(HTML(html))

def render_insight_card(insight):
    """Render an AI insight card"""
    severity_colors = {
        "high": "danger",
        "medium": "warning",
        "low": "info"
    }
    severity_icons = {
        "high": "fa-exclamation-circle",
        "medium": "fa-info-circle",
        "low": "fa-lightbulb"
    }
    
    color = severity_colors.get(insight['severity'], 'info')
    icon = severity_icons.get(insight['severity'], 'fa-info-circle')
    
    html = f"""
    <div class="alert alert-{color} border-{color}" style="border-left: 4px solid;">
        <div class="d-flex align-items-start">
            <i class="{icon} me-2" style="font-size: 1.5rem;"></i>
            <div>
                <h5 class="alert-heading">{insight['title']}</h5>
                <p class="mb-0">{insight['description']}</p>
                <small class="text-muted">Type: {insight['type'].title()}</small>
            </div>
        </div>
    </div>
    """
    display(HTML(html))

def render_visual(v):
    """Render a visualization based on type"""
    kind = v["kind"]
    title = v["title"]
    description = v.get("description", "")
    sql = v.get("sql", "")
    config = v.get("config", {})
    
    # Special handling for insights
    if kind == "insights":
        print(f"## {title}")
        if description:
            print(f"*{description}*\n")
        for insight in v.get("insights", []):
            render_insight_card(insight)
        return
    
    # Execute SQL if present
    if sql:
        df = run_sql(sql)
    else:
        df = pd.DataFrame()
    
    if kind == "kpi":
        if df.empty:
            render_kpi_card(title, "No data", icon="fa-ban", color="secondary")
            return
        
        row = df.iloc[0].to_dict()
        value = row.get("value")
        subtitle = None
        if "time" in row and row["time"]:
            subtitle = f"as of {row['time']}"
        elif "geo" in row and row["geo"]:
            subtitle = f"{row['geo']}"
        
        render_kpi_card(
            title, 
            format_number(value, config.get("format", "decimal")),
            subtitle=subtitle
        )
    
    elif kind == "line":
        print(f"## {title}")
        if description:
            print(f"*{description}*\n")
        
        if df.empty:
            print("(no data)")
            return
        
        x_col = config.get("x", "time")
        y_col = config.get("y", "value")
        color_col = config.get("color")
        
        if color_col and color_col in df.columns and df[color_col].notna().any():
            fig = px.line(df, x=x_col, y=y_col, color=color_col,
                         title=None,
                         template="plotly_white")
        else:
            fig = px.line(df, x=x_col, y=y_col,
                         title=None,
                         template="plotly_white")
        
        fig.update_layout(
            height=400,
            margin=dict(l=0, r=0, t=20, b=0),
            hovermode='x unified'
        )
        fig.show()
    
    elif kind == "bar":
        print(f"## {title}")
        if description:
            print(f"*{description}*\n")
        
        if df.empty:
            print("(no data)")
            return
        
        x_col = config.get("x", df.columns[0])
        y_col = config.get("y", df.columns[1] if len(df.columns) > 1 else "value")
        color_col = config.get("color")
        orientation = config.get("orientation", "vertical")
        
        if orientation == "horizontal":
            x_col, y_col = y_col, x_col
        
        if color_col and color_col in df.columns:
            fig = px.bar(df, x=x_col, y=y_col, color=color_col,
                        title=None,
                        template="plotly_white")
        else:
            fig = px.bar(df, x=x_col, y=y_col,
                        title=None,
                        template="plotly_white")
        
        fig.update_layout(
            height=400,
            margin=dict(l=0, r=0, t=20, b=0),
            showlegend=True
        )
        fig.show()
    
    elif kind == "scatter":
        print(f"## {title}")
        if description:
            print(f"*{description}*\n")
        
        if df.empty:
            print("(no data)")
            return
        
        x_col = config.get("x", "time")
        y_col = config.get("y", "value")
        color_col = config.get("color")
        
        if color_col and color_col in df.columns:
            fig = px.scatter(df, x=x_col, y=y_col, color=color_col,
                           title=None,
                           template="plotly_white")
        else:
            fig = px.scatter(df, x=x_col, y=y_col,
                           title=None,
                           template="plotly_white")
        
        fig.update_layout(
            height=400,
            margin=dict(l=0, r=0, t=20, b=0)
        )
        fig.show()
    
    elif kind == "table":
        print(f"## {title}")
        if description:
            print(f"*{description}*\n")
        
        if df.empty:
            print("(no data)")
            return
        
        # Style the dataframe
        styled_df = df.style.set_properties(**{
            'text-align': 'left',
            'font-size': '14px',
            'border-color': 'lightgray'
        }).set_table_styles([
            {'selector': 'th', 'props': [('background-color', '#f8f9fa'), ('font-weight', 'bold')]},
            {'selector': 'tr:hover', 'props': [('background-color', '#f1f3f5')]}
        ])
        display(styled_df)
    
    else:
        print(f"## {title}")
        print(f"(Unsupported visualization type: {kind})")

# Display AI Narrative
if "ai_insights" in PLAN and "narrative" in PLAN["ai_insights"]:
    display(Markdown(PLAN["ai_insights"]["narrative"]))
    print("\n---\n")

# Display Key Metrics
if "ai_insights" in PLAN and "key_metrics" in PLAN["ai_insights"]:
    print("# Key Metrics\n")
    metrics = PLAN["ai_insights"]["key_metrics"]
    
    # Display in a grid layout (4 columns via Bootstrap)
    html_parts = ['<div class="row mb-4">']
    for metric in metrics:
        value = format_number(metric.get("value"), metric.get("format", "number"))
        html_parts.append(f"""
            <div class="col-md-3">
                <div class="card text-center mb-3">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">{metric['name']}</h6>
                        <h3 class="card-title">{value}</h3>
                    </div>
                </div>
            </div>
        """)
    html_parts.append('</div>')
    display(HTML(''.join(html_parts)))

# Render all pages
for page in PLAN.get("pages", []):
    print(f"\n\n# {page['title']}")
    if page.get("description"):
        print(f"*{page['description']}*\n")
    
    for v in page.get("visuals", []):
        render_visual(v)
    
    print("\n---")

con.close()
```
