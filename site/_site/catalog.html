<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Catalog | AI Analytics Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 40px -10px rgba(139, 92, 246, 0.3); }
    </style>
</head>
<body class="bg-gray-50">
    <header class="sticky top-0 z-50 border-b bg-white/95 backdrop-blur shadow-sm">
        <nav class="mx-auto max-w-7xl flex items-center justify-between px-6 py-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg gradient-bg flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                    </svg>
                </div>
                <div>
                    <span class="text-xl font-bold">Eurostat AI Dashboards</span>
                    <span class="ml-2 bg-purple-100 text-purple-700 text-xs font-semibold px-3 py-1 rounded-full">AI Powered</span>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <span class="text-sm text-gray-600">
                    <span id="total-count" class="font-bold text-purple-600">0</span> Datasets
                </span>
                
                <!-- User Menu (shown when logged in) -->
                <div id="user-menu" class="hidden flex items-center gap-3">
                    <div class="flex items-center gap-2 bg-purple-50 px-4 py-2 rounded-lg border border-purple-200">
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span id="username" class="font-semibold text-gray-700">User</span>
                    </div>
                    <button onclick="logout()" class="text-gray-600 hover:text-red-600 transition" title="Logout">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Login/Signup Buttons (shown when not logged in) -->
                <div id="auth-buttons" class="flex items-center gap-2">
                    <a href="/login.html" class="text-purple-600 hover:text-purple-700 font-semibold px-4 py-2 rounded-lg hover:bg-purple-50 transition">
                        Login
                    </a>
                    <a href="/login.html#signup" class="gradient-bg text-white font-semibold px-4 py-2 rounded-lg hover:opacity-90 transition">
                        Sign Up
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <section class="gradient-bg px-6 pt-16 pb-12">
            <div class="max-w-6xl mx-auto text-center">
                <h1 class="text-5xl font-extrabold text-white mb-4">Intelligent Analytics Platform</h1>
                <p class="text-xl text-purple-100 mb-8">
                    Browse <span id="hero-total" class="font-bold">7,616</span> datasets across <span class="font-bold">24</span> categories
                </p>
                <div class="max-w-2xl mx-auto">
                    <div class="flex items-center gap-4 rounded-xl border-2 border-white/30 bg-white/10 px-6 py-3">
                        <svg class="w-5 h-5 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input type="text" id="search-input" placeholder="Search datasets..." 
                               class="flex-1 bg-transparent text-white placeholder-white/60 outline-none" 
                               oninput="filterDatasets()">
                    </div>
                </div>
            </div>
        </section>

        <section class="px-6 py-12 bg-white border-b">
            <div class="max-w-7xl mx-auto">
                <h2 class="text-2xl font-bold mb-6">Data Sources</h2>
                <div id="sources-grid" class="grid md:grid-cols-3 gap-6"></div>
            </div>
        </section>

        <section class="px-6 pt-12 pb-8 bg-gray-50">
            <div class="max-w-7xl mx-auto">
                <h3 class="font-semibold mb-4">Categories</h3>
                <div id="category-filters" class="flex flex-wrap gap-3"></div>
            </div>
        </section>

        <section class="px-6 py-12">
            <div class="max-w-7xl mx-auto">
                <div class="mb-6 flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">Datasets</h2>
                        <p class="text-gray-600">Showing <span id="showing-count">0</span> of <span id="total-datasets">0</span></p>
                    </div>
                    <select id="sort-select" onchange="sortDatasets()" class="border rounded-lg px-4 py-2">
                        <option value="recent">Most Recent</option>
                        <option value="title">Alphabetical</option>
                    </select>
                </div>
                <div id="datasets-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="load-more" class="mt-12 text-center hidden">
                    <button onclick="loadMore()" class="gradient-bg text-white px-8 py-3 rounded-xl font-semibold">Load More</button>
                </div>
                <div id="empty-state" class="hidden mt-12 text-center py-16">
                    <p class="text-xl font-semibold">No datasets found</p>
                </div>
            </div>
        </section>
    </main>

    <script>
        let allDatasets = [];
        let filteredDatasets = [];
        let currentCategory = 'all';
        let currentPage = 0;
        const ITEMS_PER_PAGE = 24;

        // Check authentication and show appropriate UI
        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                const userData = JSON.parse(user);
                document.getElementById('username').textContent = userData.username;
                document.getElementById('user-menu').classList.remove('hidden');
                document.getElementById('auth-buttons').classList.add('hidden');
            } else {
                document.getElementById('user-menu').classList.add('hidden');
                document.getElementById('auth-buttons').classList.remove('hidden');
            }
        }

        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            window.location.reload();
        }

        // Check auth on page load
        checkAuth();

        fetch('/catalog.json')
            .then(res => res.json())
            .then(catalog => {
                allDatasets = catalog.datasets;
                filteredDatasets = [...allDatasets];
                
                document.getElementById('total-count').textContent = catalog.total.toLocaleString();
                document.getElementById('hero-total').textContent = catalog.total.toLocaleString();
                document.getElementById('total-datasets').textContent = catalog.total.toLocaleString();
                
                renderSources(catalog.sources);
                renderCategories(catalog.categories);
                renderDatasets();
            })
            .catch(err => {
                console.error('Failed to load catalog:', err);
                document.getElementById('datasets-grid').innerHTML = '<div class="col-span-3 text-center text-red-600">Failed to load catalog</div>';
            });

        function renderSources(sources) {
            document.getElementById('sources-grid').innerHTML = `
                <div class="border-2 rounded-xl bg-white p-6 text-center">
                    <div class="text-4xl mb-3">ðŸ‡ªðŸ‡º</div>
                    <h3 class="font-bold">Eurostat</h3>
                    <p class="text-sm text-gray-600">European Union Statistics</p>
                    <p class="text-2xl font-bold text-purple-600 mt-3">${sources.estat.toLocaleString()}</p>
                    <p class="text-xs text-gray-500">datasets</p>
                </div>
            `;
        }

        function renderCategories(categories) {
            const total = Object.values(categories).reduce((a, b) => a + b, 0);
            const sortedCats = Object.entries(categories).sort((a, b) => b[1] - a[1]);
            
            document.getElementById('category-filters').innerHTML = `
                <button onclick="filterCategory('all')" class="category-btn active px-4 py-2 rounded-xl border-2 gradient-bg text-white font-semibold">
                    All ${total.toLocaleString()}
                </button>
            ` + sortedCats.slice(0, 10).map(([cat, count]) => `
                <button onclick="filterCategory('${cat}')" class="category-btn px-4 py-2 rounded-xl border-2 bg-white hover:border-purple-600">
                    ${cat} ${count}
                </button>
            `).join('');
        }

        function filterCategory(cat) {
            currentCategory = cat;
            currentPage = 0;
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('gradient-bg', 'text-white');
                btn.classList.add('bg-white');
            });
            event.target.classList.add('gradient-bg', 'text-white');
            event.target.classList.remove('bg-white');
            
            filterDatasets();
        }

        function filterDatasets() {
            const search = document.getElementById('search-input').value.toLowerCase();
            
            filteredDatasets = allDatasets.filter(ds => {
                const matchesCat = currentCategory === 'all' || ds.category === currentCategory;
                const matchesSearch = !search || ds.title.toLowerCase().includes(search) || ds.code.toLowerCase().includes(search);
                return matchesCat && matchesSearch;
            });
            
            renderDatasets();
        }

        function sortDatasets() {
            const sort = document.getElementById('sort-select').value;
            
            if (sort === 'title') {
                filteredDatasets.sort((a, b) => a.title.localeCompare(b.title));
            } else {
                filteredDatasets.sort((a, b) => new Date(b.last_updated) - new Date(a.last_updated));
            }
            
            renderDatasets();
        }

        function renderDatasets() {
            const end = (currentPage + 1) * ITEMS_PER_PAGE;
            const displayed = filteredDatasets.slice(0, end);
            
            document.getElementById('showing-count').textContent = displayed.length;
            
            if (displayed.length === 0) {
                document.getElementById('datasets-grid').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
                document.getElementById('load-more').classList.add('hidden');
                return;
            }
            
            document.getElementById('datasets-grid').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            
            document.getElementById('datasets-grid').innerHTML = displayed.map(ds => `
                <div onclick="openReport('${ds.code}')" class="card-hover border rounded-xl bg-white p-6 cursor-pointer">
                    <div class="mb-3">
                        <span class="bg-purple-100 text-purple-700 text-xs font-semibold px-3 py-1 rounded-full">${ds.category}</span>
                    </div>
                    <h3 class="font-bold text-lg mb-2 text-gray-900">${ds.title}</h3>
                    <p class="text-xs text-gray-500 font-mono mb-4">${ds.code}</p>
                    <div class="gradient-bg text-white text-center py-2 rounded-lg font-semibold text-sm">
                        View Report
                    </div>
                </div>
            `).join('');
            
            const hasMore = displayed.length < filteredDatasets.length;
            document.getElementById('load-more').classList.toggle('hidden', !hasMore);
        }

        function loadMore() {
            currentPage++;
            renderDatasets();
        }

        // Check authentication before opening report
        function openReport(datasetCode) {
            const token = localStorage.getItem('auth_token');
            
            if (!token) {
                // Show login popup
                showLoginPopup(datasetCode);
            } else {
                // User is logged in, open report
                window.location.href = `report.html?dataset=${datasetCode}`;
            }
        }

        function showLoginPopup(datasetCode) {
            // Store the dataset they wanted to view
            sessionStorage.setItem('pending_dataset', datasetCode);
            
            // Redirect to login page
            window.location.href = '/login.html';
        }
    </script>

    <!-- Login Required Modal (alternative to redirect) -->
    <div id="loginModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8">
            <div class="text-center mb-6">
                <div class="w-16 h-16 gradient-bg rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Login Required</h2>
                <p class="text-gray-600">Please sign in or create an account to view dashboards</p>
            </div>
            
            <div class="space-y-3">
                <a href="/login.html" class="block w-full gradient-bg text-white text-center py-3 rounded-lg font-semibold hover:opacity-90 transition">
                    Sign In
                </a>
                <button onclick="closeLoginModal()" class="block w-full border-2 border-gray-300 text-gray-700 text-center py-3 rounded-lg font-semibold hover:bg-gray-50 transition">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        function closeLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
        }
    </script>
</body>
</html>
