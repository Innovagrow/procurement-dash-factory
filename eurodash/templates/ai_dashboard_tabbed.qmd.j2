---
title: "{{ plan.dataset.title or plan.dataset.code }}"
subtitle: "AI-Enhanced Analytics Dashboard"
format:
  html:
    theme: cosmo
    css:
      - https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css
      - https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css
    code-fold: true
    page-layout: full
    toc: false
execute:
  echo: false
  warning: false
---

<style>
body {
    overflow-y: auto;
}
.nav-tabs {
    margin-bottom: 20px;
    border-bottom: 2px solid #dee2e6;
    position: sticky;
    top: 0;
    background: white;
    z-index: 1000;
    padding: 10px 0;
}
.nav-tabs .nav-link {
    color: #495057;
    font-weight: 500;
    border: none;
    border-bottom: 3px solid transparent;
    padding: 12px 20px;
}
.nav-tabs .nav-link.active {
    color: #8b5cf6;
    border-bottom-color: #8b5cf6;
    background: none;
}
.nav-tabs .nav-link:hover {
    border-bottom-color: #a78bfa;
    background: #f5f3ff;
}
.tab-content {
    max-height: calc(100vh - 200px);
    overflow-y: auto;
    padding: 20px;
}
.tab-pane {
    display: none;
}
.tab-pane.active {
    display: block;
}
.kpi-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);
}
.insight-card {
    border-left: 4px solid;
    margin-bottom: 15px;
    transition: transform 0.2s;
}
.insight-card:hover {
    transform: translateX(5px);
}
.metric-box {
    text-align: center;
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 15px;
}
.metric-value {
    font-size: 2em;
    font-weight: bold;
    color: #8b5cf6;
}
.metric-label {
    font-size: 0.9em;
    color: #6c757d;
    margin-top: 5px;
}
.chat-container {
    border: 2px solid #8b5cf6;
    border-radius: 12px;
    padding: 24px;
    background: linear-gradient(135deg, #faf5ff 0%, #f5f3ff 100%);
    max-height: 600px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 20px rgba(139, 92, 246, 0.1);
}
.chat-messages {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 15px;
    max-height: 400px;
}
.chat-message {
    margin-bottom: 15px;
    padding: 12px;
    border-radius: 8px;
}
.chat-message.user {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    color: white;
    margin-left: 20%;
    text-align: right;
    box-shadow: 0 2px 10px rgba(139, 92, 246, 0.3);
}
.chat-message.ai {
    background: white;
    border: 1px solid #dee2e6;
    margin-right: 20%;
}
.chat-input-group {
    display: flex;
    gap: 10px;
}
.chat-input-group input {
    flex: 1;
    padding: 12px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    font-size: 16px;
}
.chat-input-group button {
    padding: 12px 30px;
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    transition: all 0.3s ease;
}
.chat-input-group button:hover {
    background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
}
.export-buttons {
    margin: 20px 0;
}
</style>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">
      <i class="fas fa-home"></i> Overview
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="insights-tab" data-bs-toggle="tab" data-bs-target="#insights" type="button">
      <i class="fas fa-lightbulb"></i> AI Insights
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="trends-tab" data-bs-toggle="tab" data-bs-target="#trends" type="button">
      <i class="fas fa-chart-line"></i> Trends
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="anomalies-tab" data-bs-toggle="tab" data-bs-target="#anomalies" type="button">
      <i class="fas fa-exclamation-triangle"></i> Anomalies
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="comparison-tab" data-bs-toggle="tab" data-bs-target="#comparison" type="button">
      <i class="fas fa-globe"></i> Geographic
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button">
      <i class="fas fa-comments"></i> AI Chat
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="export-tab" data-bs-toggle="tab" data-bs-target="#export" type="button">
      <i class="fas fa-download"></i> Export
    </button>
  </li>
</ul>

```{python}
#| echo: false
#| output: asis
import json
from pathlib import Path
import duckdb
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from IPython.display import Markdown, HTML, display

PLAN_PATH = Path("../../plans") / "{{ plan.dataset.code }}_ai.json"
PLAN = json.loads(PLAN_PATH.read_text(encoding="utf-8"))
DB_PATH = Path("../../warehouse/duckdb/eurodash.duckdb")
DATASET_CODE = "{{ plan.dataset.code }}"

con = duckdb.connect(str(DB_PATH), read_only=True)

def run_sql(sql: str) -> pd.DataFrame:
    try:
        return con.execute(sql).df()
    except Exception as e:
        print(f"<!-- SQL Error: {e} -->")
        return pd.DataFrame()

# Pre-load all data for tabs
df_all = run_sql(f"SELECT * FROM fact_observations WHERE dataset_code='{DATASET_CODE}'")
df_latest = run_sql(f"SELECT time, value FROM fact_observations WHERE dataset_code='{DATASET_CODE}' ORDER BY time DESC LIMIT 1")
df_trend = run_sql(f"SELECT time, AVG(value) as value FROM fact_observations WHERE dataset_code='{DATASET_CODE}' GROUP BY time ORDER BY time")
df_geo = run_sql(f"""
    WITH latest AS (SELECT MAX(time) as max_time FROM fact_observations WHERE dataset_code='{DATASET_CODE}')
    SELECT geo, value FROM fact_observations
    WHERE dataset_code='{DATASET_CODE}' AND time = (SELECT max_time FROM latest)
    ORDER BY value DESC LIMIT 30
""")

# Calculate anomalies
if not df_all.empty and 'value' in df_all.columns:
    mean_val = df_all['value'].mean()
    std_val = df_all['value'].std()
    df_all['z_score'] = (df_all['value'] - mean_val) / std_val if std_val > 0 else 0
    df_all['is_anomaly'] = abs(df_all['z_score']) > 3
else:
    df_all['is_anomaly'] = False

print("")  # Start HTML output
```

```{python}
#| echo: false
#| output: asis

# Start tab content
print('<div class="tab-content" id="dashboardTabContent">')
print('<div class="tab-pane fade show active" id="overview" role="tabpanel">')
```

```{python}
#| echo: false
#| output: asis
    
    # Display Key Metrics
    if 'ai_insights' in PLAN and 'key_metrics' in PLAN['ai_insights']:
        metrics = PLAN['ai_insights']['key_metrics']
        
        html = '<div class="row">'
        for metric in metrics:
            value = metric.get('value', 0)
            if metric.get('format') == 'decimal':
                value_str = f"{value:,.2f}"
            elif metric.get('format') == 'number':
                value_str = f"{int(value):,}"
            else:
                value_str = str(value)
            
            html += f'''
            <div class="col-md-4 col-lg-2">
                <div class="metric-box">
                    <div class="metric-value">{value_str}</div>
                    <div class="metric-label">{metric.get("name", "")}</div>
                </div>
            </div>
            '''
        html += '</div>'
        display(HTML(html))
    
    # Display latest KPI
    if not df_latest.empty:
        latest_value = df_latest.iloc[0]['value']
        latest_time = df_latest.iloc[0]['time']
        html = f'''
        <div class="kpi-card">
            <h4>Latest Value</h4>
            <h1>{latest_value:,.2f}</h1>
            <p>as of {latest_time}</p>
        </div>
        '''
        display(HTML(html))
    
    # Quick trend
    if not df_trend.empty:
        fig = px.line(df_trend, x='time', y='value', title='Trend Overview')
        fig.update_layout(template='plotly_white', height=300)
        fig.show()
```

```{python}
#| echo: false
#| output: asis
print('</div>')  # Close overview tab
print('<div class="tab-pane fade" id="insights" role="tabpanel">')
```

```{python}
#| echo: false
#| output: asis
    
    if 'ai_insights' in PLAN and 'narrative' in PLAN['ai_insights']:
        display(Markdown(PLAN['ai_insights']['narrative']))
    
    if 'ai_insights' in PLAN and 'insights' in PLAN['ai_insights']:
        print("\n## Detected Insights\n")
        
        for insight in PLAN['ai_insights']['insights']:
            severity = insight.get('severity', 'info')
            colors = {'high': 'danger', 'medium': 'warning', 'low': 'info'}
            color = colors.get(severity, 'info')
            icons = {'high': 'exclamation-circle', 'medium': 'info-circle', 'low': 'lightbulb'}
            icon = icons.get(severity, 'info-circle')
            
            html = f'''
            <div class="alert alert-{color} insight-card" style="border-left-color: var(--bs-{color});">
                <div class="d-flex align-items-start">
                    <i class="fas fa-{icon} me-3" style="font-size: 1.5rem;"></i>
                    <div class="flex-grow-1">
                        <h5 class="alert-heading">{insight.get('title', '')}</h5>
                        <p class="mb-1">{insight.get('description', '')}</p>
                    </div>
                </div>
            </div>
            '''
            display(HTML(html))
```

```{python}
#| echo: false
#| output: asis
print('</div>')  # Close insights tab
print('<div class="tab-pane fade" id="trends" role="tabpanel">')
print("## Historical Trends\n")

df_trend_full = run_sql(f"""
    SELECT time, geo, AVG(value) as value 
    FROM fact_observations 
    WHERE dataset_code='{DATASET_CODE}' 
    GROUP BY time, geo ORDER BY time
""")

if not df_trend_full.empty:
    fig = px.line(df_trend_full, x='time', y='value', color='geo',
                 title='Trend Over Time by Region')
    fig.update_layout(template='plotly_white', height=400, hovermode='x unified')
    fig.show()

print("\n## Year-over-Year Growth\n")

df_yoy = run_sql(f"""
    WITH yoy AS (
        SELECT time, geo, value,
            LAG(value) OVER (PARTITION BY geo ORDER BY time) as prev_value
        FROM fact_observations WHERE dataset_code='{DATASET_CODE}'
    )
    SELECT time, geo, ((value / NULLIF(prev_value, 0)) - 1) * 100 as growth_rate
    FROM yoy WHERE prev_value IS NOT NULL
    ORDER BY time DESC LIMIT 50
""")

if not df_yoy.empty:
    fig = px.bar(df_yoy, x='time', y='growth_rate', color='geo',
                title='Year-over-Year Growth Rate (%)')
    fig.update_layout(template='plotly_white', height=350)
    fig.show()
```

```{python}
#| echo: false
#| output: asis
print('</div>')  # Close trends tab
print('<div class="tab-pane fade" id="anomalies" role="tabpanel">')
```

```{python}
#| echo: false
#| output: asis

print("## Anomaly Detection\n")

anomaly_insight = None
for insight in PLAN.get('ai_insights', {}).get('insights', []):
    if insight.get('type') == 'anomaly':
        anomaly_insight = insight
        break

if anomaly_insight:
    data_points = anomaly_insight.get('data_points', {})
    html = f'''
    <div class="alert alert-warning">
        <h5><i class="fas fa-exclamation-triangle"></i> {anomaly_insight.get('title', '')}</h5>
        <p>{anomaly_insight.get('description', '')}</p>
    </div>
    '''
    display(HTML(html))

if not df_all.empty:
    fig = px.scatter(df_all, x='time', y='value', color='is_anomaly',
                    title='Data Points with Anomalies Highlighted',
                    color_discrete_map={True: 'red', False: 'blue'})
    fig.update_layout(template='plotly_white', height=400)
    fig.show()
```

```{python}
#| echo: false
#| output: asis
print('</div>')  # Close anomalies tab
print('<div class="tab-pane fade" id="comparison" role="tabpanel">')
print("## Geographic Comparison\n")

if not df_geo.empty:
    fig = px.bar(df_geo, x='geo', y='value', title='Latest Values by Region')
    fig.update_layout(template='plotly_white', height=400)
    fig.show()
```

```{python}
#| echo: false
#| output: asis

print('</div>')  # Close comparison tab
print('''
<div class="tab-pane fade" id="chat" role="tabpanel">
  <h3><i class="fas fa-comments"></i> Chat with AI About Your Data</h3>
  <p class="text-muted">Ask questions in natural language and get instant SQL-powered answers</p>
  
  <div class="chat-container">
    <div class="chat-messages" id="chatMessages">
      <div class="chat-message ai">
        <strong><i class="fas fa-robot"></i> AI Assistant</strong>
        <p>Hello! I can help you analyze the {{ plan.dataset.code }} dataset. Try asking:</p>
        <ul>
          <li>"What is the latest value?"</li>
          <li>"Which country has the highest value?"</li>
          <li>"Show me the trend"</li>
          <li>"What is the average?"</li>
        </ul>
      </div>
    </div>
    
    <div class="chat-input-group">
      <input type="text" id="chatInput" placeholder="Type your question here..." />
      <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i> Send</button>
    </div>
  </div>
  
  <script>
    const DATASET_CODE = "{{ plan.dataset.code }}";
    const DB_PATH = "../../warehouse/duckdb/eurodash.duckdb";
    
    const queryPatterns = [
      {
        pattern: /what is the latest|latest value|most recent/i,
        sql: `SELECT time, value FROM fact_observations WHERE dataset_code='${DATASET_CODE}' ORDER BY time DESC LIMIT 1`,
        answer: "The latest value is {value} as of {time}"
      },
      {
        pattern: /highest|maximum|largest|most/i,
        sql: `WITH latest AS (SELECT MAX(time) as t FROM fact_observations WHERE dataset_code='${DATASET_CODE}')
              SELECT geo, value FROM fact_observations 
              WHERE dataset_code='${DATASET_CODE}' AND time=(SELECT t FROM latest)
              ORDER BY value DESC LIMIT 1`,
        answer: "The highest value is {value} in {geo}"
      },
      {
        pattern: /lowest|minimum|smallest|least/i,
        sql: `WITH latest AS (SELECT MAX(time) as t FROM fact_observations WHERE dataset_code='${DATASET_CODE}')
              SELECT geo, value FROM fact_observations 
              WHERE dataset_code='${DATASET_CODE}' AND time=(SELECT t FROM latest)
              ORDER BY value ASC LIMIT 1`,
        answer: "The lowest value is {value} in {geo}"
      },
      {
        pattern: /average|mean/i,
        sql: `SELECT AVG(value) as average FROM fact_observations WHERE dataset_code='${DATASET_CODE}'`,
        answer: "The average value is {average}"
      },
      {
        pattern: /trend|over time/i,
        sql: `SELECT time, AVG(value) as value FROM fact_observations WHERE dataset_code='${DATASET_CODE}' GROUP BY time ORDER BY time`,
        answer: "Here's the trend data (see chart below)"
      }
    ];
    
    function sendMessage() {
      const input = document.getElementById('chatInput');
      const question = input.value.trim();
      
      if (!question) return;
      
      // Add user message
      addMessage(question, 'user');
      input.value = '';
      
      // Find matching pattern
      let response = "I'm not sure how to answer that. Try asking about the latest value, trends, or comparisons.";
      
      for (const pattern of queryPatterns) {
        if (pattern.pattern.test(question)) {
          response = `<i class="fas fa-search"></i> Searching data...<br><br>` +
                    `<strong>SQL Query:</strong><br><code>${pattern.sql}</code><br><br>` +
                    `<em>Note: In a full implementation, this would execute the query and show results.</em><br><br>` +
                    `Expected answer: ${pattern.answer}`;
          break;
        }
      }
      
      // Add AI response
      setTimeout(() => {
        addMessage(response, 'ai');
      }, 500);
    }
    
    function addMessage(text, type) {
      const messagesDiv = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${type}`;
      
      if (type === 'user') {
        messageDiv.innerHTML = `<strong><i class="fas fa-user"></i> You</strong><p>${text}</p>`;
      } else {
        messageDiv.innerHTML = `<strong><i class="fas fa-robot"></i> AI Assistant</strong><p>${text}</p>`;
      }
      
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    // Allow Enter key to send
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
  </script>
''')

```{python}
#| echo: false
#| output: asis

print('</div>')  # Close chat tab
print('<div class="tab-pane fade" id="export" role="tabpanel">')
print("## Export Dashboard\n")

html = '''
<div class="export-buttons">
    <h5><i class="fas fa-download"></i> Export Options</h5>
    <p>Download this dashboard in various formats.</p>
        
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                        <h6>PDF Report</h6>
                        <button class="btn btn-outline-danger btn-sm">
                            <i class="fas fa-download"></i> Export PDF
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-file-powerpoint fa-3x text-warning mb-3"></i>
                        <h6>PowerPoint</h6>
                        <button class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-download"></i> Export PPTX
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-file-excel fa-3x text-success mb-3"></i>
                        <h6>Excel</h6>
                        <button class="btn btn-outline-success btn-sm">
                            <i class="fas fa-download"></i> Export XLSX
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
'''
display(HTML(html))

con.close()
```

```{python}
#| echo: false
#| output: asis

print('</div>')  # Close export tab
print('</div>')  # Close tab-content
print('<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>')
